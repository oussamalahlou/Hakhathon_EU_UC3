<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Approbation automatique</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:#f3f4f6;padding:24px}
    .card{max-width:760px;margin:24px auto;padding:18px;background:#fff;border-radius:12px;border:1px solid #e5e7eb}
    h1{margin:0 0 12px;font-size:1.25rem}
    .meta{color:#334155;margin:8px 0}
    .btns{margin-top:18px}
    button{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .approve{background:#10b981;color:#fff;margin-right:8px}
    .decline{background:#ef4444;color:#fff}
    pre{background:#f8fafc;border:1px dashed #cbd5e1;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Approbation automatique requise</h1>

    <!-- GDPR consent text -->
    <div class="consent" style="margin:12px 0;padding:12px;background:#fff;border-radius:8px;border:1px solid #e6eef8;color:#0f172a;line-height:1.45">
      <p>Avoir pris connaissance de la Politique de confidentialité et des Conditions Générales de Vente.</p>
      <p>Autoriser ECOIA à utiliser vos données personnelles pour :</p>
      <ul>
        <li>analyser et vérifier votre demande,</li>
        <li>générer votre contrat,</li>
        <li>procéder à la signature électronique,</li>
        <li>assurer la mise en service de votre offre d’énergie,</li>
        <li>et communiquer avec vous dans le cadre de votre souscription.</li>
      </ul>
      <p>Consentir expressément à ce traitement dans le cadre du Règlement Général sur la Protection des Données (RGPD).</p>
      <p>En cliquant sur “J’accepte et je continue”, vous donnez votre consentement libre, éclairé et explicite pour le traitement de vos données dans le cadre de la présente souscription.</p>
    </div>

    <div class="btns">
      <button class="approve" id="approveBtn">J’accepte et je continue</button>
      <button class="decline" id="declineBtn">Je refuse</button>
    </div>

    <div id="resultMsg" style="margin-top:12px"></div>
  </div>

  <script>
    function el(id){ return document.getElementById(id); }

    const raw = sessionStorage.getItem('serverResponse');
    let data = null;
    try{ data = raw ? JSON.parse(raw) : null; }catch(e){ data = null; }

  

    async function sendApproval(approve){
      if(!data) return;
      el('resultMsg').textContent = 'Envoi en cours...';
      try{
        const resp = await fetch('/api/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ requestId: data.requestId, approve })
        });
        const json = await resp.json();
        if(resp.ok){
          // Wait 2 seconds before showing the final message
          await new Promise(resolve => setTimeout(resolve, 2000));
          el('resultMsg').textContent = 'Votre demande sera traitée et votre contrat sera envoyé par email pour la signature.';
          el('resultMsg').style.color = '#059669';
          el('resultMsg').style.fontWeight = '500';
          // clear session and disable buttons
          sessionStorage.removeItem('serverResponse');
          el('approveBtn').disabled = true;
          el('declineBtn').disabled = true;
          // Hide buttons
          document.querySelector('.btns').style.display = 'none';
        } else {
          el('resultMsg').textContent = 'Erreur: ' + (json && json.message ? json.message : resp.status);
        }
      }catch(err){
        el('resultMsg').textContent = 'Erreur réseau: ' + (err && err.message ? err.message : String(err));
      }
    }

    el('approveBtn').addEventListener('click', ()=> sendApproval(true));
    el('declineBtn').addEventListener('click', ()=> sendApproval(false));
  </script>
</body>
</html>
